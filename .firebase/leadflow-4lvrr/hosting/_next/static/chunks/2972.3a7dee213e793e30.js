"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2972],{16923:(e,t,s)=>{s.d(t,{A:()=>a});let a=(0,s(40157).A)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]])},17759:(e,t,s)=>{s.d(t,{C5:()=>j,MJ:()=>f,Rr:()=>g,eI:()=>h,lR:()=>x,lV:()=>c,zB:()=>m});var a=s(95155),r=s(12115),l=s(99708),n=s(62177),o=s(59434),i=s(85057);let c=n.Op,d=r.createContext({}),m=e=>{let{...t}=e;return(0,a.jsx)(d.Provider,{value:{name:t.name},children:(0,a.jsx)(n.xI,{...t})})},u=()=>{let e=r.useContext(d),t=r.useContext(p),{getFieldState:s,formState:a}=(0,n.xW)(),l=s(e.name,a);if(!e)throw Error("useFormField should be used within <FormField>");let{id:o}=t;return{id:o,name:e.name,formItemId:"".concat(o,"-form-item"),formDescriptionId:"".concat(o,"-form-item-description"),formMessageId:"".concat(o,"-form-item-message"),...l}},p=r.createContext({}),h=r.forwardRef((e,t)=>{let{className:s,...l}=e,n=r.useId();return(0,a.jsx)(p.Provider,{value:{id:n},children:(0,a.jsx)("div",{ref:t,className:(0,o.cn)("space-y-2",s),...l})})});h.displayName="FormItem";let x=r.forwardRef((e,t)=>{let{className:s,...r}=e,{error:l,formItemId:n}=u();return(0,a.jsx)(i.J,{ref:t,className:(0,o.cn)(l&&"text-destructive",s),htmlFor:n,...r})});x.displayName="FormLabel";let f=r.forwardRef((e,t)=>{let{...s}=e,{error:r,formItemId:n,formDescriptionId:o,formMessageId:i}=u();return(0,a.jsx)(l.DX,{ref:t,id:n,"aria-describedby":r?"".concat(o," ").concat(i):"".concat(o),"aria-invalid":!!r,...s})});f.displayName="FormControl";let g=r.forwardRef((e,t)=>{let{className:s,...r}=e,{formDescriptionId:l}=u();return(0,a.jsx)("p",{ref:t,id:l,className:(0,o.cn)("text-sm text-muted-foreground",s),...r})});g.displayName="FormDescription";let j=r.forwardRef((e,t)=>{var s;let{className:r,children:l,...n}=e,{error:i,formMessageId:c}=u(),d=i?String(null!=(s=null==i?void 0:i.message)?s:""):l;return d?(0,a.jsx)("p",{ref:t,id:c,className:(0,o.cn)("text-sm font-medium text-destructive",r),...n,children:d}):null});j.displayName="FormMessage"},52972:(e,t,s)=>{s.r(t),s.d(t,{default:()=>A});var a=s(95155),r=s(90221),l=s(62177),n=s(71153),o=s(30285),i=s(54165),c=s(17759),d=s(62523),m=s(30356),u=s(87481),p=s(56104),h=s(35317),x=s(90858),f=s(12115),g=s(83662),j=s(50172),N=s(16923);let v=(0,s(40157).A)("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);var y=s(25318),b=s(98030),w=s(53282),C=s(99297),k=s(26133),I=s(47650);let T=[];for(let e=8;e<=22;e++){let t=e>12?e-12:e,s=e>=12?"PM":"AM",a=0===t?12:t;T.push({value:"".concat(e.toString().padStart(2,"0"),":00"),label:"".concat(a,":00 ").concat(s)}),e<22&&T.push({value:"".concat(e.toString().padStart(2,"0"),":30"),label:"".concat(a,":30 ").concat(s)})}let R=n.Ik({customerName:n.Yj().min(2,{message:"Customer name must be at least 2 characters."}),customerPhone:n.Yj().min(10,{message:"Phone number must be at least 10 digits."}).regex(/^\+?[0-9\s()-]+$/,{message:"Invalid phone number format."}),address:n.Yj().min(5,{message:"Address must be at least 5 characters."}),dispatchType:n.k5(["immediate","scheduled"],{required_error:"Please select a dispatch type."}),appointmentDate:n.p6().optional(),appointmentTime:n.Yj().optional(),assignedCloserId:n.Yj().optional(),photos:n.YO(n.Nl(File)).max(5,{message:"Maximum 5 photos allowed."}).optional()}).superRefine((e,t)=>{if("scheduled"===e.dispatchType&&(e.appointmentDate||t.addIssue({code:n.eq.custom,message:"Date is required for scheduled dispatch.",path:["appointmentDate"]}),e.appointmentTime||t.addIssue({code:n.eq.custom,message:"Time is required for scheduled dispatch.",path:["appointmentTime"]}),e.appointmentDate&&e.appointmentTime)){let[s,a]=e.appointmentTime.split(":").map(Number),r=new Date(e.appointmentDate);r.setHours(s,a,0,0),r<=new Date&&t.addIssue({code:n.eq.custom,message:"Scheduled appointment must be in the future.",path:["appointmentDate"]})}if(e.photos)for(let s=0;s<e.photos.length;s++){let a=e.photos[s];a.size>5242880&&t.addIssue({code:n.eq.custom,message:"Photo ".concat(s+1," is too large. Maximum size is 5MB."),path:["photos"]}),a.type.startsWith("image/")||t.addIssue({code:n.eq.custom,message:"File ".concat(s+1," is not an image."),path:["photos"]})}});function A(e){let{isOpen:t,onClose:s}=e,{user:n}=(0,b.A)(),{toast:A}=(0,u.dj)(),[D,S]=(0,f.useState)(!1),[F,M]=(0,f.useState)([]),[P,q]=(0,f.useState)(!1),[E,L]=(0,f.useState)(!1),[z,U]=(0,f.useState)(!1),[B,V]=(0,f.useState)([]),J=(0,f.useRef)(null),Y=(0,f.useRef)(null),[_,O]=(0,f.useState)(!1),H=(0,l.mN)({resolver:(0,r.u)(R),defaultValues:{customerName:"",customerPhone:"",address:"",dispatchType:"immediate",photos:[]}}),$=H.watch("dispatchType"),G=H.watch("photos")||[];(0,f.useEffect)(()=>{"scheduled"!==$||H.getValues("appointmentTime")||H.setValue("appointmentTime","17:00")},[$,H]),(0,f.useEffect)(()=>{O(!0)},[]),(0,f.useEffect)(()=>{let e=e=>{Y.current&&!Y.current.contains(e.target)&&q(!1)};if(P)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[P]);let W=(0,f.useCallback)(async e=>{if(e.length<3){M([]),q(!1);return}L(!0);try{let t="your-actual-api-key";if(!t){console.warn("Google Maps API key not configured or not in browser environment"),M([]),q(!1);return}let s=await fetch("/api/places-autocomplete?input=".concat(encodeURIComponent(e),"&key=").concat(encodeURIComponent(t)));if(s.ok){let e=await s.json();M(e.predictions||[]),q(!0)}else console.error("Places API response not ok:",s.status),M([]),q(!1)}catch(e){console.error("Error fetching address predictions:",e),M([]),q(!1)}finally{L(!1)}},[]),X=(0,f.useCallback)(e=>{let t=Array.from(e.target.files||[]),s=H.getValues("photos")||[];if(s.length+t.length>5)return void A({title:"Too many photos",description:"Maximum 5 photos allowed.",variant:"destructive"});let a=t.map(e=>{try{return URL.createObjectURL(e)}catch(e){return console.error("Error creating object URL:",e),""}}).filter(e=>""!==e);V(e=>[...e,...a]),H.setValue("photos",[...s,...t])},[H,A]),K=(0,f.useCallback)(e=>{let t=H.getValues("photos")||[];B[e]&&URL.revokeObjectURL(B[e]);let s=t.filter((t,s)=>s!==e),a=B.filter((t,s)=>s!==e);H.setValue("photos",s),V(a)},[H,B]),Z=async e=>{U(!0);let t=e.map(async(e,t)=>{let s="leads/".concat(Date.now(),"-").concat(t,"-").concat(e.name),a=(0,x.KR)(p.IG,s),r=await (0,x.D)(a,e);return(0,x.qk)(r.ref)});try{return await Promise.all(t)}finally{U(!1)}},Q=async e=>{if(n){S(!0);try{let t=[];e.photos&&e.photos.length>0&&(t=await Z(e.photos));let a=e.assignedCloserId&&e.assignedCloserId===(null==n?void 0:n.uid)?{uid:n.uid,name:n.displayName||n.email||"Self"}:null,r={customerName:e.customerName,customerPhone:e.customerPhone,address:e.address,dispatchType:e.dispatchType,status:"immediate"===e.dispatchType?"waiting_assignment":"scheduled",teamId:n.teamId,createdAt:(0,h.serverTimestamp)(),updatedAt:(0,h.serverTimestamp)(),setterId:n.uid,setterName:n.displayName||n.email,setterLocation:null,assignedCloserId:(null==a?void 0:a.uid)||null,assignedCloserName:(null==a?void 0:a.name)||null,dispositionNotes:"",photoUrls:t};if("scheduled"===e.dispatchType&&e.appointmentDate&&e.appointmentTime){let[t,s]=e.appointmentTime.split(":").map(Number),a=new Date(e.appointmentDate);a.setHours(t,s,0,0),r.scheduledAppointmentTime=h.Dc.fromDate(a)}let l=await (0,h.gS)((0,h.collection)(p.db,"leads"),r);try{await w.t0.newLead({id:l.id,customerName:e.customerName,customerPhone:e.customerPhone,address:e.address,status:r.status,teamId:n.teamId,dispatchType:e.dispatchType,assignedCloserId:(null==a?void 0:a.uid)||null,assignedCloserName:(null==a?void 0:a.name)||null,createdAt:new Date,updatedAt:new Date,setterId:n.uid,setterName:n.displayName||n.email||"Unknown",setterLocation:null,dispositionNotes:"",scheduledAppointmentTime:r.scheduledAppointmentTime||null,photoUrls:t})}catch(e){console.error("Error sending new lead notification:",e)}A({title:"Lead created successfully",description:"Lead for ".concat(e.customerName," has been created.")}),H.reset(),V([]),s()}catch(e){console.error("Error creating lead:",e),A({title:"Error creating lead",description:"Please try again.",variant:"destructive"})}finally{S(!1)}}};return(0,f.useEffect)(()=>()=>{B.forEach(e=>URL.revokeObjectURL(e))},[B]),(0,a.jsx)(i.lG,{open:t,onOpenChange:s,children:(0,a.jsxs)(i.Cf,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto isolate fixed",children:[(0,a.jsxs)(i.c7,{children:[(0,a.jsx)(i.L3,{className:"text-lg sm:text-xl",children:"Create New Lead"}),(0,a.jsx)(i.rr,{className:"text-sm sm:text-base",children:"Fill out the form below to create a new lead."})]}),(0,a.jsx)(c.lV,{...H,children:(0,a.jsxs)("form",{onSubmit:H.handleSubmit(Q),className:"space-y-4 sm:space-y-6 relative isolate",children:[(0,a.jsx)(c.zB,{control:H.control,name:"customerName",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Customer Name"}),(0,a.jsx)(c.MJ,{children:(0,a.jsx)(d.p,{placeholder:"Enter customer name",className:"text-sm sm:text-base",...t})}),(0,a.jsx)(c.C5,{})]})}}),(0,a.jsx)(c.zB,{control:H.control,name:"customerPhone",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Phone Number"}),(0,a.jsx)(c.MJ,{children:(0,a.jsx)(d.p,{placeholder:"Enter phone number",className:"text-sm sm:text-base",...t})}),(0,a.jsx)(c.C5,{})]})}}),(0,a.jsx)(c.zB,{control:H.control,name:"address",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Address"}),(0,a.jsx)(c.MJ,{children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(g.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,a.jsx)(d.p,{ref:Y,placeholder:"Enter address",className:"pl-10 text-sm sm:text-base",...t,onChange:e=>{t.onChange(e),W(e.target.value)},onFocus:()=>{F.length>0&&q(!0)},onBlur:()=>{setTimeout(()=>q(!1),200)}}),E&&(0,a.jsx)(j.A,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground"})]}),P&&F.length>0&&_&&(0,a.jsx)(a.Fragment,{children:(0,I.createPortal)((0,a.jsx)("div",{className:"fixed z-[9999] bg-popover border rounded-md shadow-lg max-h-60 overflow-y-auto min-w-[300px]",style:{top:Y.current?Y.current.getBoundingClientRect().bottom+window.scrollY+4:0,left:Y.current?Y.current.getBoundingClientRect().left+window.scrollX:0,width:Y.current?Y.current.getBoundingClientRect().width:300},children:F.map(e=>(0,a.jsx)("div",{className:"px-3 py-2 cursor-pointer hover:bg-muted text-sm",onClick:()=>{t.onChange(e.description),q(!1),M([])},children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(g.A,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),(0,a.jsx)("span",{className:"truncate",children:e.description})]})},e.place_id))}),document.body)})]})}),(0,a.jsx)(c.C5,{})]})}}),(0,a.jsx)(c.zB,{control:H.control,name:"dispatchType",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{className:"space-y-3",children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Dispatch Type"}),(0,a.jsx)(c.MJ,{children:(0,a.jsxs)(m.z,{onValueChange:t.onChange,defaultValue:t.value,className:"flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-6",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(m.C,{value:"immediate",id:"immediate"}),(0,a.jsx)("label",{htmlFor:"immediate",className:"text-sm sm:text-base cursor-pointer",children:"Immediate Dispatch"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(m.C,{value:"scheduled",id:"scheduled"}),(0,a.jsx)("label",{htmlFor:"scheduled",className:"text-sm sm:text-base cursor-pointer",children:"Scheduled Dispatch"})]})]})}),(0,a.jsx)(c.C5,{})]})}}),["manager","closer"].includes((null==n?void 0:n.role)||"")&&(0,a.jsx)(c.zB,{control:H.control,name:"assignedCloserId",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Assign to Self"}),(0,a.jsx)(c.Rr,{className:"text-xs sm:text-sm",children:"Assign this lead directly to yourself, bypassing the assignment queue."}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"checkbox",id:"assignToSelf",checked:t.value===(null==n?void 0:n.uid),onChange:e=>{t.onChange(e.target.checked?null==n?void 0:n.uid:"")},className:"h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"}),(0,a.jsx)("label",{htmlFor:"assignToSelf",className:"text-sm cursor-pointer",children:"Assign this lead to me"})]}),(0,a.jsx)(c.C5,{})]})}}),"scheduled"===$&&(0,a.jsxs)("div",{className:"space-y-4 p-4 bg-muted/50 rounded-lg isolate",children:[(0,a.jsx)("h4",{className:"font-medium text-sm sm:text-base",children:"Schedule Appointment"}),(0,a.jsx)("div",{className:"text-sm text-muted-foreground",children:"Select a date and time for the scheduled appointment:"}),(0,a.jsx)(c.zB,{control:H.control,name:"appointmentDate",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Date"}),(0,a.jsx)(c.MJ,{children:(0,a.jsx)("div",{className:"isolate",children:(0,a.jsx)(C.l,{date:t.value,onDateChange:t.onChange,placeholder:"Select appointment date",className:"text-sm sm:text-base"})})}),(0,a.jsx)(c.C5,{})]})}}),(0,a.jsx)(c.zB,{control:H.control,name:"appointmentTime",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Time"}),(0,a.jsx)(c.MJ,{children:(0,a.jsx)("div",{className:"isolate",children:(0,a.jsx)(k.A,{time:t.value,onTimeChange:t.onChange,placeholder:"Select appointment time",className:"text-sm sm:text-base",timeSlots:T})})}),(0,a.jsx)(c.C5,{})]})}})]}),(0,a.jsx)(c.zB,{control:H.control,name:"photos",render:e=>{let{field:t}=e;return(0,a.jsxs)(c.eI,{children:[(0,a.jsx)(c.lR,{className:"text-sm sm:text-base",children:"Photos"}),(0,a.jsx)(c.Rr,{className:"text-xs sm:text-sm",children:"Upload up to 5 photos. Maximum 5MB per photo."}),(0,a.jsx)(c.MJ,{children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)(o.$,{type:"button",variant:"outline",size:"sm",className:"text-sm",onClick:()=>{var e;return null==(e=J.current)?void 0:e.click()},disabled:G.length>=5,children:[(0,a.jsx)(N.A,{className:"h-4 w-4 mr-2"}),"Upload Photos"]}),G.length>0&&(0,a.jsxs)("span",{className:"text-xs text-muted-foreground",children:[G.length,"/5 photos"]})]}),(0,a.jsx)("input",{ref:J,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:X}),G.length>0&&(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:B.map((e,t)=>(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("div",{className:"aspect-square rounded-lg overflow-hidden bg-muted",children:e?(0,a.jsx)("img",{src:e,alt:"Preview ".concat(t+1),className:"w-full h-full object-cover"}):(0,a.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-muted",children:(0,a.jsx)(v,{className:"h-8 w-8 text-muted-foreground"})})}),(0,a.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",className:"absolute -top-2 -right-2 h-6 w-6 rounded-full p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>K(t),children:(0,a.jsx)(y.A,{className:"h-3 w-3"})}),(0,a.jsxs)("div",{className:"absolute bottom-1 left-1 bg-black/50 text-white text-xs px-1 rounded",children:[(0,a.jsx)(v,{className:"h-3 w-3 inline mr-1"}),t+1]})]},t))})]})}),(0,a.jsx)(c.C5,{})]})}}),(0,a.jsxs)(i.Es,{className:"flex flex-col sm:flex-row gap-2 sm:gap-0 dark:border-turquoise/20",children:[(0,a.jsx)(i.HM,{asChild:!0,children:(0,a.jsx)(o.$,{type:"button",variant:"outline",className:"text-sm sm:text-base dark:card-glass dark:glow-cyan dark:border-turquoise/30 dark:hover:glow-turquoise",children:"Cancel"})}),(0,a.jsx)(o.$,{type:"submit",disabled:D||z,className:"text-sm sm:text-base bg-gradient-to-r from-[#3574F2] to-[#5096F2] hover:from-[#3574F2]/90 hover:to-[#5096F2]/90 dark:from-turquoise dark:to-cyan dark:hover:from-turquoise/90 dark:hover:to-cyan/90 dark:glow-turquoise",children:D?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(j.A,{className:"mr-2 h-4 w-4 animate-spin"}),z?"Uploading...":"Creating..."]}):"Create Lead"})]})]})})]})})}}}]);